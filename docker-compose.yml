
version: "3.4"
networks:
  proxynetwork:
    external: true
  net:
    driver: overlay
    attachable: true

volumes:
    mariadb_data:
services:
    strapi:
        image: strapi/strapi:3.6.5
        environment:
            DATABASE_CLIENT: mysql
            DATABASE_HOST: mariadb
            DATABASE_PORT: 3306
            DATABASE_NAME: core
            DATABASE_USERNAME: siteinternet
            DATABASE_PASSWORD: password
            DATABASE_SSL: 'false'
        volumes:
            - ./app:/srv/app
        depends_on:
            - mariadb
        networks:
            - net
            - proxynetwork
        deploy:
            labels:
                - "traefik.enable=true"
                - "traefik.http.routers.strapi.rule=HostRegexp(`strapi.traefik.me`, `strapi.{ip:.*}.traefik.me`)"
                - "traefik.http.routers.strapi-tls.tls.domains[0].main=strapi.traefik.me"
                - "traefik.http.routers.strapi-tls.tls.domains[0].sans=strapi-*.traefik.me"
                - "traefik.http.services.strapi.loadbalancer.server.port=1337"
    mariadb:
        image: mariadb:10.5.9
        environment:
            MYSQL_ROOT_PASSWORD: example
            MYSQL_DATABASE: core
            MYSQL_USER: siteinternet
            MYSQL_PASSWORD: password
            TZ: Europe/Paris
        networks:
            - net
        volumes:
            - mariadb_data:/var/lib/mysql
            - ${PWD}/dump:/dump
        deploy:
        labels:
            - "traefik.enable=false"
    phpmyadmin:
        image: phpmyadmin/phpmyadmin:5.1.0
        environment:
            PMA_HOST: mariadb
            MYSQL_ROOT_PASSWORD: example
        depends_on:
            - mariadb
        networks:
            - net
            - proxynetwork
        deploy:
            labels:
                - "traefik.enable=true"
                - "traefik.http.routers.phpmyadmin-strapi.rule=HostRegexp(`phpmyadmin-strapi.traefik.me`, `phpmyadmin-strapi.{ip:.*}.traefik.me`)"
                - "traefik.http.routers.phpmyadmin-strapi-tls.tls.domains[0].main=phpmyadmin-strapi.traefik.me"
                - "traefik.http.routers.phpmyadmin-strapi-tls.tls.domains[0].sans=phpmyadmin-strapi-*.traefik.me"
                - "traefik.http.services.phpmyadmin-strapi.loadbalancer.server.port=80"